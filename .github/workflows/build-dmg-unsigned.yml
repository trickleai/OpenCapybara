name: Build Capybara DMG (Unsigned)

# This workflow builds the DMG without code signing
# Use this temporarily when you don't have access to certificates

on:
  push:
    branches:
      - dev-sam-disable
  pull_request:
    branches:
      - dev-sam-disable

env:
  NODE_VERSION: '22.21.1'

jobs:
  build:
    name: Build Capybara for macOS (ARM64) - Unsigned
    runs-on: macos-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install extension dependencies
        run: |
          cd extensions/capybara-defaults && npm ci
          cd ../capybara-agent && npm ci

      - name: Compile project
        run: npm run compile

      - name: Download Electron
        run: npm run electron

      - name: Build macOS app (darwin-arm64)
        run: npm run gulp -- vscode-darwin-arm64
        timeout-minutes: 45

      - name: Sign application (ad-hoc)
        run: |
          APP_PATH="../VSCode-darwin-arm64/Capybara.app"

          echo "Signing with ad-hoc signature (no Apple Developer certificate required)"

          codesign --deep --force \
            --sign - \
            --entitlements build/darwin/entitlements.plist \
            --options runtime \
            "$APP_PATH"

          # Remove quarantine attribute
          xattr -cr "$APP_PATH"

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

      - name: Create DMG
        run: |
          # Install create-dmg if needed
          brew install create-dmg || true

          APP_PATH="../VSCode-darwin-arm64/Capybara.app"
          DMG_PATH="./Capybara-macOS-arm64.dmg"

          # Create DMG (no signing)
          create-dmg \
            --volname "Capybara" \
            --volicon "resources/darwin/capybara.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Capybara.app" 175 190 \
            --hide-extension "Capybara.app" \
            --app-drop-link 425 190 \
            "$DMG_PATH" \
            "$APP_PATH" || {
              # Fallback to manual DMG creation if create-dmg fails
              echo "create-dmg failed, using fallback method"
              bash scripts/create-dmg.sh
            }

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          COMMIT_SHA=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y%m%d-%H%M%S")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Rename DMG with version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          COMMIT="${{ steps.version.outputs.commit }}"
          DATE="${{ steps.version.outputs.date }}"

          mv Capybara-macOS-arm64.dmg "Capybara-${VERSION}-${COMMIT}-darwin-arm64-UNSIGNED.dmg"

      - name: Configure AWS credentials
        if: env.AWS_ACCESS_KEY_ID != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}

      - name: Upload to S3
        if: env.AWS_ACCESS_KEY_ID != ''
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          VERSION: ${{ steps.version.outputs.version }}
          COMMIT: ${{ steps.version.outputs.commit }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        run: |
          DMG_FILE="Capybara-${VERSION}-${COMMIT}-darwin-arm64-UNSIGNED.dmg"

          # Upload with version in path
          aws s3 cp "$DMG_FILE" \
            "s3://${S3_BUCKET}/releases/${VERSION}/${DMG_FILE}" \
            --acl private

          # Also upload as "latest" for easy access
          aws s3 cp "$DMG_FILE" \
            "s3://${S3_BUCKET}/releases/latest/Capybara-latest-darwin-arm64-UNSIGNED.dmg" \
            --acl private

          # Generate presigned URL (valid for 7 days)
          DOWNLOAD_URL=$(aws s3 presign \
            "s3://${S3_BUCKET}/releases/${VERSION}/${DMG_FILE}" \
            --expires-in 604800)

          echo "Download URL (valid for 7 days):" >> $GITHUB_STEP_SUMMARY
          echo "$DOWNLOAD_URL" >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: Capybara-macOS-arm64-${{ steps.version.outputs.version }}-UNSIGNED
          path: Capybara-*-UNSIGNED.dmg
          retention-days: 30

      - name: Create release notes
        id: release-notes
        run: |
          cat << EOF > release-notes.md
          ## Capybara ${{ steps.version.outputs.version }} (Unsigned Build)

          **⚠️ This is an UNSIGNED build for testing purposes.**

          **Build Information:**
          - Version: ${{ steps.version.outputs.version }}
          - Commit: ${{ steps.version.outputs.commit }}
          - Build Date: ${{ steps.version.outputs.date }}
          - Platform: macOS (Apple Silicon)
          - Signature: Ad-hoc (not notarized)

          **Installation:**
          1. Download the DMG file
          2. Open the DMG and drag Capybara to Applications
          3. **Important:** On first launch, you'll need to:
             - Right-click the app and select "Open"
             - Or go to System Settings → Privacy & Security → Click "Open Anyway"

          **What's Included:**
          - Custom Capybara extensions (capybara-defaults, capybara-agent)
          - Simplified UI for knowledge work
          - Session Dashboard
          - Automatic workspace setup

          **Note:** This build uses ad-hoc signing and is NOT notarized by Apple.
          Users will need to manually approve it in System Settings.
          EOF

          cat release-notes.md >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const commit = '${{ steps.version.outputs.commit }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ✅ Build Successful (Unsigned)\n\n**Version:** ${version}\n**Commit:** ${commit}\n\n⚠️ This is an unsigned build for testing. Users will need to manually approve in System Settings.\n\nCheck the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for download links.`
            });
